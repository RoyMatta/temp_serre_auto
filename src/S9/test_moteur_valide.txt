#include <Adafruit_MCP23X17.h>  //SPI
#include <Adafruit_MAX31865.h>  //PT100 température
#include <Wire.h>

#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

#define PWM1 26
#define DIR1 25      

#define MOTEUR_ARRET 0
#define MOTEUR_MONTEE 1
#define MOTEUR_DESCENTE 2

//Définition de la structure du moteur
typedef struct T_Moteur {
  int pwm;    //pin responsable du pwm
  int dir;    //pin responsable de la direction du moteur
  int etat;    //valuer qui indique l'état du moteur
//   unsigned long timestamp; //timestamp responsable de la durée de marche du moteur
//   int capteur_FC_haut;  //capteur de fin de course haut
//   int capteur_FC_bas;  //capteur de fin de course bas
//   int pin_LED_temoin;  //Led qui indique l'état du moteur s'il est en marche ou arret
} T_Moteur ;

T_Moteur lMoteurs[]= 
  {
     { PWM1, DIR1, MOTEUR_ARRET} //0, MOTEUR_A_FC_HAUT, MOTEUR_A_FC_BAS, LED_MARCHE_MOT_A}, //Moteur 1
    //  { PWM2, DIR2, MOTEUR_ARRET} //0, MOTEUR_B_FC_HAUT, MOTEUR_B_FC_BAS, LED_MARCHE_MOT_B} //Moteur 2
  };

/// @brief arrete le moteur grâce à son numéro (0 ou 1)
/// @param numero 
void arretMoteur(int numero) {
  if(lMoteurs[numero].etat == MOTEUR_ARRET) {
    return;
  }
  digitalWrite(lMoteurs[numero].dir, LOW);
  digitalWrite(lMoteurs[numero].pwm, LOW);
  lMoteurs[numero].etat = MOTEUR_ARRET;
}

void monteeMoteur(int numero) { //demarrage du moteur
  if(lMoteurs[numero].etat == MOTEUR_MONTEE) { //si déjà actif
    return;
  }
  digitalWrite(lMoteurs[numero].pwm, HIGH);
  digitalWrite(lMoteurs[numero].dir, LOW);    //TBD REMPLACER LOW par sens_montee et définir sens_montée
  lMoteurs[numero].etat = MOTEUR_MONTEE;
}

void descenteMoteur(int numero) { //demarrage du moteur
  if(lMoteurs[numero].etat == MOTEUR_DESCENTE) { //si déjà actif
    return;
  }
  digitalWrite(lMoteurs[numero].pwm, HIGH);
  digitalWrite(lMoteurs[numero].dir, HIGH);   //TBD
  lMoteurs[numero].etat = MOTEUR_DESCENTE;
}

bool isMoteurActif(int numero) {
  return !(lMoteurs[numero].etat == MOTEUR_ARRET);
}

void setup() {

    Serial.begin(115200);
    delay(1000);
    Serial.println("Demarrage test moteur");
    
    pinMode(lMoteurs[0].pwm, OUTPUT);
    pinMode(lMoteurs[0].dir, OUTPUT);
    arretMoteur(0);

}
  
void loop() {

    monteeMoteur(0);       //amorçage montée
    Serial.println("Montée moteur A");
    delay(5000);


    descenteMoteur(0);         //amorçage descente
    Serial.println("Descente moteur A");
    delay(5000);

    arretMoteur(0);
    Serial.println("Arrêt moteur A");
    delay(2000);

    Serial.println("Looping...");
}