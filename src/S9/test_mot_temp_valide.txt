#include <Adafruit_MCP23X17.h>  //SPI
#include <Adafruit_MAX31865.h>  //PT100 température
#include <Wire.h>
#include <SPI.h>

#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

#define PWM1 26
#define DIR1 25      

#define MOTEUR_ARRET 0
#define MOTEUR_MONTEE 1
#define MOTEUR_DESCENTE 2

// Pins SPI Communication
#define MOSI_pin    23
#define MISO_pin    19
#define CLK_pin     18
// Pins CS températureAmplificateur de sonde de température PT100 MAX31865
#define MODULE_TEMP_A_CS  2
#define MODULE_TEMP_B_CS  15
// Variables température
#define RREF      430.0 // The value of the reference resistor. Use 430.0 for PT100
#define RNOMINAL  100.0 // The 'nominal' 0-degrees-C resistance of the sensor. Use 100.0 for PT100


Adafruit_MAX31865 thermo1 = Adafruit_MAX31865(MODULE_TEMP_A_CS, MOSI_pin, MISO_pin, CLK_pin);
Adafruit_MAX31865 thermo2 = Adafruit_MAX31865(MODULE_TEMP_B_CS, MOSI_pin, MISO_pin, CLK_pin);


//Définition de la structure du moteur
typedef struct T_Moteur {
  int pwm;    //pin responsable du pwm
  int dir;    //pin responsable de la direction du moteur
  int etat;    //valuer qui indique l'état du moteur
//   unsigned long timestamp; //timestamp responsable de la durée de marche du moteur
//   int capteur_FC_haut;  //capteur de fin de course haut
//   int capteur_FC_bas;  //capteur de fin de course bas
//   int pin_LED_temoin;  //Led qui indique l'état du moteur s'il est en marche ou arret
} T_Moteur ;

T_Moteur lMoteurs[]= 
  {
     { PWM1, DIR1, MOTEUR_ARRET} //0, MOTEUR_A_FC_HAUT, MOTEUR_A_FC_BAS, LED_MARCHE_MOT_A}, //Moteur 1
    //  { PWM2, DIR2, MOTEUR_ARRET} //0, MOTEUR_B_FC_HAUT, MOTEUR_B_FC_BAS, LED_MARCHE_MOT_B} //Moteur 2
  };

float readTemp(Adafruit_MAX31865& thermo1, Adafruit_MAX31865& thermo2);
void arretMoteur(int numero);
void monteeMoteur(int numero);
void descenteMoteur(int numero);
bool isMoteurActif(int numero);

void setup() {

    Serial.begin(115200);
    delay(1000);
    Serial.println("Demarrage test moteur et température");

    // Initialize SPI
    thermo1.begin(MAX31865_3WIRE);
    thermo2.begin(MAX31865_3WIRE);
    
    pinMode(lMoteurs[0].pwm, OUTPUT);
    pinMode(lMoteurs[0].dir, OUTPUT);
    arretMoteur(0);

}
  
void loop() {

    float temp = readTemp(thermo1, thermo2);
    Serial.print("Température moyenne: ");
    Serial.print(temp);
    Serial.println(" °C");

    if(temp <= 27.0) {
        Serial.println("Température en dessous de 27°C, descente du moteur A");
        descenteMoteur(0);
    } else if (temp >= 29.0) {
        Serial.println("Température au dessus de 29°C, montée du moteur A");
        monteeMoteur(0);
    } else {
        Serial.println("Température entre 27°C et 29°C, arrêt du moteur A");
        arretMoteur(0);
    }
    delay(1000);

    Serial.println("Looping...");
}

float readTemp(Adafruit_MAX31865& thermo1, Adafruit_MAX31865& thermo2) {
    float temp1 = thermo1.temperature(RNOMINAL, RREF);
    float temp2 = thermo2.temperature(RNOMINAL, RREF);
    return (temp1 + temp2) / 2.0;
}

/// @brief arrete le moteur grâce à son numéro (0 ou 1)
/// @param numero 
void arretMoteur(int numero) {
  if(lMoteurs[numero].etat == MOTEUR_ARRET) {
    return;
  }
  digitalWrite(lMoteurs[numero].dir, LOW);
  digitalWrite(lMoteurs[numero].pwm, LOW);
  lMoteurs[numero].etat = MOTEUR_ARRET;
}

void monteeMoteur(int numero) { //demarrage du moteur
  if(lMoteurs[numero].etat == MOTEUR_MONTEE) { //si déjà actif
    return;
  }
  digitalWrite(lMoteurs[numero].pwm, HIGH);
  digitalWrite(lMoteurs[numero].dir, LOW);    //TBD REMPLACER LOW par sens_montee et définir sens_montée
  lMoteurs[numero].etat = MOTEUR_MONTEE;
}

void descenteMoteur(int numero) { //demarrage du moteur
  if(lMoteurs[numero].etat == MOTEUR_DESCENTE) { //si déjà actif
    return;
  }
  digitalWrite(lMoteurs[numero].pwm, HIGH);
  digitalWrite(lMoteurs[numero].dir, HIGH);   //TBD
  lMoteurs[numero].etat = MOTEUR_DESCENTE;
}

bool isMoteurActif(int numero) {
  return !(lMoteurs[numero].etat == MOTEUR_ARRET);
}